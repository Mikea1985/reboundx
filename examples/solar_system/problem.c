/**
 * Solar System
 *
 * This example integrates all planets of the Solar
 * System. The data comes from the NASA HORIZONS system. 
 *
 * MJH modified this to use the current Horizons values for
 * 2458850.500000000 = A.D. 2020-Jan-02 00:00:00.0000 TDB 
 * with Earth-Moon barycenter.
 *
 * Included are:
 * J2 and J4 for the Earth
 * GR (not full and not just the potential)
 * Sun through Pluto
 * the Earth and Moon as separate bodies
 * the five most massive asteroids (Ceres, Pallas, Vesta, Hygiea, Euphrosyne)
 *
 * The positions and velocities below are barycentric in J2000 equatorial 
 * coordinates.
 *
 * They are for the barycenter of each planet-satellite system.
 *
 */
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <math.h>
#include "rebound.h"
#include "reboundx.h"


  double ss_pos[11][3] = 
{
  {  -3.806970428568225E-03,  6.814915142455261E-03,  2.979979794391853E-03},
  {  -4.483197903907063E-02, -4.040469928695153E-01, -2.122467673617313E-01},
  {   7.175669160844040E-01,  8.959290823156696E-02, -5.417939136045495E-03},
  {  -1.873644112110868E-01,  8.931079109417208E-01,  3.871904536517273E-01},
  {  -1.846732108084085E-01,  8.931077434616120E-01,  3.869232391790001E-01},
  {  -1.315545177843986E+00, -8.207169267317594E-01, -3.411872423116151E-01},
  {   5.297640391546605E-01, -4.767843483746686E+00, -2.056559031901711E+00},
  {   3.798298738597670E+00, -8.516940807784746E+00,  -3.681508462812138E+00},
  {   1.621940960222534E+01,  1.051642864149670E+01,  4.376512297621163E+00},
  {   2.923965738403363E+01, -5.616148426257757E+00, -3.026685073040035E+00},
  {   1.297589331951759E+01, -2.861614813408223E+01, -1.283981981411902E+01},

  /*
{1.012997529094287e+00, -2.379864780644146e+00, -1.329421626793677e+00},
{1.231008367665249e+00, 2.145129143422291e+00, 6.933882623003288e-01},
{-6.125040826831212e-01, -2.996245121052788e+00, 6.402146596409393e-01},
{1.254640747669655e+00, 2.932008137585146e+00, 1.414739944509501e+00},
{-1.959921423721031e+00, -2.456862158705799e+00, -1.914664693296445e+00},
{-3.280152523188475e+00, 9.543039466915946e-01, -6.441750490219622e-01},
{-9.432116793587240e-01, 2.224587830354601e+00, 1.013938327008840e+00},
{2.145804502369941e+00, -6.480349728174213e-02, 4.300825023901620e-01},
{-2.852921775781804e+00, 9.776547755844399e-02, 1.350024694881294e-01},
{2.525080298235844e+00, -4.007069555047651e-01, -2.244435769360298e-01},
{-3.252913589483365e+00, -3.577761947676257e-01, -4.223914788011562e-02},
{8.799134588692252e-01, 2.526007638389968e+00, 1.213773613674364e+00},
{-3.059188877167531e+00, -9.456808481862998e-01, -3.090470300321771e-01},
{2.809385935979135e+00, 1.196526804161355e+00, 1.032337161626889e-01},
{-2.427995944334550e+00, -2.163813447267069e+00, -2.265242243103587e-01},
{-1.518749725023424e+00, 2.898882289733594e+00, 1.765195610207921e+00},

{-1.335906976346672e+00, -2.318424413837180e+00, -1.094151987948509e+00},
{2.870254689127128e+00, 1.180062629803167e+00, 1.119557156035309e-02},
{1.764548025884835e+00, 1.382102179544113e+00, 7.951085928307765e-01},
{-2.790845367104964e+00, -5.772819646962899e-01, -2.341753055080184e-01},
{2.620555143276786e+00, 3.507489252237163e-01, -3.921250624807464e-01},
{-3.076374663105100e+00, -5.025973491800968e-01, -1.287571644696279e+00},
{-1.990722077293652e+00, -2.013829008093776e+00, -2.552059325291470e+00},
{-1.836685009365025e+00, 2.623036110264773e+00, 6.743294047329040e-01},
{-2.474293541657801e+00, -1.160787976348014e-01, 4.977870259638211e-01},
{2.885038317808807e+00, -1.736608250160741e+00, -6.450573731135235e-01},
  */
  
  //{   1.012997529094287E+00, -2.379864780644146E+00, -1.329421626793677E+00},
  //{  -6.125040826831212E-01, -2.996245121052788E+00,  6.402146596409393E-01},
  //{   1.231008367665249E+00,  2.145129143422291E+00,  6.933882623003288E-01},
  //{   1.254640747669655E+00,  2.932008137585146E+00,  1.414739944509501E+00},
  //{  -1.959921423721031E+00, -2.456862158705799E+00, -1.914664693296445E+00},

};

double ss_vel[11][3] = 
{
  {  -8.349682484704309E-06, -1.927817097051818E-06, -5.848107438376956E-07},
  {   2.237244442364164E-02, -1.137339038057510E-04, -2.380260521816932E-03},
  {  -2.113717904207005E-03,  1.822029721991904E-02,  8.331742401888597E-03},
  {  -1.719161464308643E-02, -3.014054231668059E-03, -1.306167700040788E-03},
  {  -1.716986411989030E-02, -2.499090037979507E-03, -1.093029414634773E-03},
  {   8.409520861938068E-03, -9.335895393281725E-03, -4.509015944114901E-03},
  {   7.414885651992408E-03,  1.100553338803863E-03,  2.912674933299398E-04},
  {   4.853933533583929E-03,  2.015595051272250E-03,  6.234798290252488E-04},
  {  -2.289160082073187E-03,  2.768713364560998E-03,  1.244995749546069E-03},
  {   6.460312447697148E-04,  2.862676264819695E-03,  1.155626149514257E-03},
  {   2.971946862746633E-03,  8.526810884260379E-04, -6.293502827572323E-04},

  /*
{9.181286221966607e-03, 3.396920004853876e-03, -2.697298914044804e-04},
{-8.809402736663648e-03, 4.423168328201815e-03, 2.914973690688229e-03},
{8.367350244221035e-03, -3.499555312609033e-03, 1.007263698560838e-04},
{-8.189972948110812e-03, 2.875751464524533e-03, 7.143107960462970e-04},
  {5.960599510196264e-03, -2.721583042748283e-03, -4.886954226168587e-03},
{-1.934519085030417e-03, -7.197324562102510e-03, -4.267332309672975e-03},
{-1.060872088043321e-02, -4.259933575276004e-03, 1.606072230019193e-03},
{-1.715118336082694e-03, 1.113407693282093e-02, 5.569761565064332e-03},
{-2.819856558222644e-03, -9.272701564440938e-03, -1.629768705752790e-03},
{1.370857329270948e-03, 1.054879254310906e-02, 3.958144406101893e-03},
{2.040811558467988e-03, -8.907126146643228e-03, -3.331783023412212e-03},
{-8.712363172030241e-03, 4.266281135839945e-03, 1.038140297536327e-03},
{2.351563205600781e-03, -8.740064051616132e-03, -2.638628230108675e-03},
{-4.720114013333352e-03, 8.074925337934165e-03, 3.251015159038643e-03},
{5.410197542696381e-03, -6.090675182938344e-03, -4.277821460851984e-03},
{-7.952006891079361e-03, -3.384295965986535e-03, -6.691021132950748e-05},


{8.244336046233204e-03, -3.457151397155407e-03, -5.782602977770417e-04},
{-2.916051874780490e-03, 7.951262113582432e-03, 4.738010955534003e-03},
{-7.894601464808557e-03, 7.359523382840125e-03, 4.104564489943742e-03},
{1.414537865305784e-03, -9.606212019931660e-03, -4.298325421670350e-03},
{-9.612463257417974e-04, 8.227478416592066e-03, 6.134438625375700e-03},
{3.540597496905861e-03, -8.629037605989476e-03, -1.300796798752589e-03},
{5.749180244491767e-03, -4.598327989892250e-03, -2.630549458123999e-03},
{-8.165281257011723e-03, -5.368350404639248e-03, -1.102958727335654e-03},
{-4.564479226390836e-04, -1.121675055370563e-02, -1.697902446748308e-03},
{4.887667570939066e-03, 5.240512953281591e-03, 4.872073461859213e-03},
  */
  
  //{   9.181286221966607E-03,  3.396920004853876E-03, -2.697298914044804E-04},
  //{   8.367350244221035E-03, -3.499555312609033E-03,  1.007263698560838E-04},
  //{  -8.809402736663648E-03,  4.423168328201815E-03,  2.914973690688229E-03},
  //{  -8.189972948110812E-03,  2.875751464524533E-03,  7.143107960462970E-04},
  //{   5.960599510196264E-03, -2.721583042748283E-03, -4.886954226168587E-03},

};

double ss_mass[11] =
{
  0.295912208285591100E-03, // sun
  0.491248045036476000E-10, // mercury
  0.724345233264412000E-09, // venus
  0.888769244512563400E-09, // earth
  0.109318945074237400E-10, // moon
  0.954954869555077000E-10, // mars
  0.282534584083387000E-06, // jupiter
  0.845970607324503000E-07, // saturn
  0.129202482578296000E-07, // uranus
  0.152435734788511000E-07, // neptune
  0.217844105197418000E-11, // pluto

    /*
1.400476556172344e-13,
3.854750187808810e-14,
3.104448198938713e-14,
1.235800787294125e-14,
6.343280473648602e-15,

5.256168678493662e-15,
5.198126979457498e-15,
4.678307418350905e-15,
3.617538317147937e-15,
3.411586826193812e-15,
3.180659282652541e-15,
2.577114127311047e-15,
2.531091726015068e-15,
2.476788101255867e-15,
2.295559390637462e-15,
2.199295173574073e-15,

2.136434442571407e-15,
2.112438360599952e-15,
1.975842365124520e-15,
1.893901667525382e-15,
1.797004894507446e-15,
1.755899183324700e-15,
1.745955726270500e-15,
1.671720991700644e-15,
1.585098657159689e-15,
1.546567695624325e-15,
    */
    
    //0.140047655617234400E-12,
    //0.310444819893871300E-13,
    //0.385475018780881000E-13,
    //0.123580078729412500E-13,
    //0.634328047364860200E-14,
    
};

void heartbeat(struct reb_simulation* r);
double e_init;
double tmax;

int main(int argc, char* argv[]){
    struct reb_simulation* r = reb_create_simulation();
    // Setup constants
    r->dt             = 1;                // in days
    tmax            = 100;            // 200 Myr
    r->G            = 1.0;
    //r->ri_whfast.safe_mode     = 0;        // Turn off safe mode. Need to call reb_integrator_synchronize() before outputs. 
    //r->ri_whfast.corrector     = 11;        // 11th order symplectic corrector
    //r->integrator        = REB_INTEGRATOR_WHFAST;
    r->integrator        = REB_INTEGRATOR_IAS15;        // Alternative non-symplectic integrator
    r->heartbeat        = heartbeat;
    r->exact_finish_time = 1; // Finish exactly at tmax in reb_integrate(). Default is already 1.

    // Initial conditions
    for (int i=0;i<11;i++){
        struct reb_particle p = {0};
        p.x  = ss_pos[i][0];         p.y  = ss_pos[i][1];         p.z  = ss_pos[i][2];
        p.vx = ss_vel[i][0];         p.vy = ss_vel[i][1];         p.vz = ss_vel[i][2];
        p.m  = ss_mass[i];
        reb_add(r, p); 
    }

    // Test Particles
    for (int i=0;i<1;i++){
        double a = reb_random_uniform(0.4,20.);
        double e = reb_random_uniform(0.01,0.2);
        double omega = reb_random_uniform(0.,2.*M_PI);
        double f = reb_random_uniform(0.,2.*M_PI);
        struct reb_particle p = reb_tools_orbit2d_to_particle(1.,r->particles[0],0.,a,e,omega,f);
        reb_add(r, p); 
    }
    
    reb_move_to_com(r);

    struct rebx_extras* rebx = rebx_attach(r);
    // Could also add "gr" or "gr_full" here.  See documentation for details.
    struct rebx_force* gr = rebx_load_force(rebx, "gr");
    rebx_add_force(rebx, gr); 
    // Have to set speed of light in right units (set by G & initial conditions).  Here we use default units of AU/(yr/2pi)
    rebx_set_param_double(rebx, &gr->ap, "c", 173.144632674);

    struct rebx_force* gh = rebx_load_force(rebx, "gravitational_harmonics");
    rebx_add_force(rebx, gh);

    rebx_set_param_double(rebx, &r->particles[3].ap, "J2", 1.0826254500000000E-03);
    rebx_set_param_double(rebx, &r->particles[3].ap, "J4", -1.6198980000000000E-06);
    rebx_set_param_double(rebx, &r->particles[3].ap, "R_eq", 4.26352077751e-5);
    
    //e_init = reb_tools_energy(r);
    //system("rm -f energy.txt");

    reb_integrate(r, tmax);

    rebx_free(rebx);    // this explicitly frees all the memory allocated by REBOUNDx     
}

void heartbeat(struct reb_simulation* r){
    if (reb_output_check(r, 10.)){
        reb_output_timing(r, tmax);
        reb_integrator_synchronize(r);
        //FILE* f = fopen("energy.txt","a");
        //double e = reb_tools_energy(r);
        //fprintf(f,"%e %e\n",r->t, fabs((e-e_init)/e_init));
        //fclose(f);

        FILE* g = fopen("states.txt","a");
        fprintf(g,"%e\n",r->t);
        fclose(g);
	reb_output_ascii(r, "states.txt");
    }
}

